extends ../layout

block content
  .container-fluid
    if !turnos || turnos.length === 0
      .alert.alert-info
        h4.alert-heading No hay turnos disponibles
        p No se encontraron turnos para mostrar.
    else
      .row
        .col-md-12
          .card
            .card-header.d-flex.justify-content-between.align-items-center
              h4.mb-0 Gestión de Turnos
              a.btn.btn-primary(href='/turno/buscarAgenda')
                i.fas.fa-calendar-plus.me-1
                | Reservar Turno
            
            .card-body
              h6.text-center.text-danger.mb-4 Se listan todos los turnos Reservados y Confirmados
              
              .table-responsive
                table#tablaTurnosSecretario.table.table-striped.table-bordered
                  thead.text-center
                    tr
                      th Paciente
                      th Agenda
                      th Clínica
                      th Fecha
                      th Hora
                      th Estado
                      th Acciones
                  
                  tbody.text-center
                    each turno in turnos
                      tr
                        td= turno.persona_nombre ? `${turno.persona_nombre} ${turno.persona_apellido}` : 'Sin asignar'
                        td= turno.nombreagenda
                        td= turno.sucursal_nombre
                        td(data-order=moment(turno.fechaturno).format('YY/MM/DD'))
                          = moment(turno.fechaturno).format('DD/MM/YYYY')
                        td= turno.inicioturno
                        td
                          span(class=`badge ${turno.estado_tipo === 'Confirmado' ? 'bg-success' : 'bg-warning'}`)
                            = turno.estado_tipo
                        td
                          .btn-group
                            a.btn.btn-info.btn-sm(href=`/turno/ver?id=${turno.turniid}&perTurId=${turno.PersonaId}`)
                              i.fas.fa-eye.me-1
                              | Ver
                            button.btn.btn-success.btn-sm(onclick=`confirmarTurno(${turno.turniid})` type='button')
                              i.fas.fa-check.me-1
                              | Confirmar

block scripts
  script(src="//cdn.jsdelivr.net/npm/sweetalert2@11")
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script.
    function confirmarTurno(turnoId) {
        Swal.fire({
            title: '¿Está seguro?',
            text: "¿Desea confirmar este turno?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/turno/confirmar/${turnoId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(() => {
                    Swal.fire(
                        '¡Confirmado!',
                        'El turno ha sido confirmado exitosamente',
                        'success'
                    ).then(() => {
                        window.location.href = '/turno/secretario';
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error',
                        'No se pudo confirmar el turno',
                        'error'
                    );
                });
            }
        });
    } 